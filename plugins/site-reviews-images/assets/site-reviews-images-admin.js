!function(){"use strict";var e=Backbone.Collection.extend({model:wp.media.model.Attachment,initialize:function(e,t){var i=this;this.controller=t.controller||new e.Controller,this.on("add remove reset",(function(){return i.controller.set("length",i.length)}))},add:function(e,t){if(!e)return this;e.hasOwnProperty("length")?e instanceof wp.media.model.Attachments&&(e=e.models):e=[e],e=_.difference(e,this.models),Backbone.Collection.prototype.add.call(this,e,t)},destroyAll:function(){_.each(_.clone(this.models),(function(e){return e.destroy()}))}}),t=Backbone.Model.extend({defaults:{ids:[],length:0},initialize:function(){this.set("ids",_.without(_.map(this.get("ids"),Number),0,-1)),this.set("items",new e([],{controller:this}))}}),i="site-reviews-images",n=wp.media.controller.Library.extend({defaults:_.defaults({filterable:"uploaded",library:{search:i,type:"image"},multiple:"add",priority:100,searchable:!1,syncSelection:!1},wp.media.controller.Library.prototype.defaults),activate:function(){var e=this.get("library"),t=this.frame.options.edit;this.editLibrary&&this.editLibrary!==t&&e.unobserve(this.editLibrary),e.validator=function(e){return!!this.mirroring.get(e.cid)&&!t.get(e.cid)&&wp.media.model.Selection.prototype.validator.apply(this,arguments)},e.reset(e.mirroring.models,{silent:!0}),e.observe(t),this.editLibrary=t,wp.media.controller.Library.prototype.activate.apply(this,arguments)}}),o=n,r=wp.media.view.MediaFrame.Select.extend({createStates:function(){var e=this.options;e.states||this.states.add([new o({library:wp.media.query(e.library),multiple:e.multiple,priority:20})])}}),l=Backbone.View.extend({className:"glsri-media-add",tagName:"div",template:wp.template("glsri-media-button"),events:{"click button":"onClick"},initialize:function(e){this.controller=e.controller,this.collection=this.controller.get("items"),this.render()},onClick:function(e){var t=this;e.preventDefault(),this._frame&&this._frame.dispose(),this._frame=new r({edit:this.collection,editing:!0,library:{search:i,type:"image"},multiple:"add"}),this._frame.on("open",(function(){var e=t._frame.content.get();e&&e.collection&&(e.collection.mirroring._hasMore=!0,e.collection.more())})),this._frame.on("select",(function(){var e=t._frame.state().get("selection");t.collection.add(e.models)})),this._frame.open()},render:function(){return this.$el.html(this.template({text:GLSR.addons[i].text.add})),this}}),s=wp.media.view.Attachment.Details.TwoColumn.extend({render:function(){var e=this;wp.media.view.Attachment.Details.prototype.render.apply(this,arguments),this.players=this.players||[],wp.media.mixin.unsetPlayers.call(this),this.$("audio, video").each((function(t,i){var n=wp.media.view.MediaDetails.prepareSrc(i);e.players.push(new window.MediaElementPlayer(n,wp.media.mixin.mejsSettings))}))}}),a=s,c=wp.media.view.MediaFrame.EditAttachments.extend({editMetadataMode:function(e){e.view=new a({controller:this,model:this.model}),e.view.views.set(".attachment-compat",new wp.media.view.AttachmentCompat({controller:this,model:this.model}))},resetRoute:function(){}}),d=Backbone.View.extend({className:"glsri-media-item attachment",tagName:"div",template:wp.template("glsri-media-item"),events:{"click .glsri-edit-media":"onClickEdit","click .glsri-remove-media":"onClickRemove","click .glsri-switch-media":"onClickSwitch"},initialize:function(e){this.controller=e.controller,this.collection=this.controller.get("items"),this.render(),this.listenTo(this.model,"change",this.render),this.$el.data("id",this.model.cid)},onClickEdit:function(e){e.preventDefault(),this.trigger("click:edit",this.model)},onClickRemove:function(e){e.preventDefault(),this.trigger("click:remove",this.model)},onClickSwitch:function(e){e.preventDefault(),this.trigger("click:switch",this.model)},render:function(){var e=this.model.toJSON();return e.controller=this.controller.toJSON(),this.$el.html(this.template(e)),this}}),h=Backbone.View.extend({className:"glsri-media-list",tagName:"div",initialize:function(e){var t=this;this.controller=e.controller,this.collection=this.controller.get("items"),this.itemView=d,this.getItemView=_.memoize((function(e){var i=new t.itemView({controller:t.controller,model:e});return t.listenToItemView(i),i}),(function(e){return e.cid})),this.listenTo(this.collection,"add",this.addItemView),this.listenTo(this.collection,"remove",this.removeItemView),this.listenTo(this.collection,"reset",this.resetItemViews),this.$el.sortable({helper:"clone"})},addItemView:function(e){var t=this.collection.indexOf(e),i=this.getItemView(e).el,n=this.$el.children();0>=t?this.$el.prepend(i):n.length<=t?this.$el.append(i):n.eq(t-1).after(i)},editItem:function(e){this._editFrame&&this._editFrame.dispose(),this._editFrame=new c({controller:{gridRouter:new wp.media.view.MediaFrame.Manage.Router},frame:"edit-attachments",library:this.collection,model:e}),this._editFrame.open()},listenToItemView:function(e){this.listenTo(e,"click:remove",this.removeItem),this.listenTo(e,"click:switch",this.switchItem),this.listenTo(e,"click:edit",this.editItem)},removeItem:function(e){this.collection.remove(e)},removeItemView:function(e){this.getItemView(e).$el.detach()},resetItemViews:function(e){_.each(that.models,this.removeItemView),e.each(this.addItemView)},switchItem:function(e){var t=this;return this._switchFrame&&this._switchFrame.dispose(),this._switchFrame=new r({edit:this.collection,editing:!0,library:{search:i,type:"image"},multiple:!1}),this._switchFrame.on("open",(function(){var e=t._switchFrame.content.get();e&&e.collection&&(e.collection.mirroring._hasMore=!0,e.collection.more())})),this._switchFrame.on("select",(function(){var i=t._switchFrame.state().get("selection"),n=t.collection,o=n.indexOf(e);_.isEmpty(i)||(n.remove(e),n.add(i,{at:o}))})),this._switchFrame.open(),!1}}),m=Backbone.View.extend({className:"glsri-media-field",initialize:function(e){var i=this;wp.media.model.Attachments.prototype.constructor.filters.search=function(){return!0},this.$inputEl=jQuery(e.input);var n=_.extend({fieldName:e.input.name+"[]",ids:this.$inputEl.val().split(",")},this.$inputEl.data("options"));this.controller=new t(n),this.createList(),this.createAddButton(),this.render(),this.loadInitialAttachments();var o=this.controller.get("items");this.$inputEl.on("remove",(function(){return i.controller.destroy()})),this.$inputEl.on("media:reset",(function(){return o.reset()})),o.on("add remove reset",_.debounce((function(){var e=o.pluck("id").join(",");i.$inputEl.val(e).trigger("change",[i.$(".glsri-media-input")])}),500))},createAddButton:function(){this.addButton=new l({controller:this.controller})},createList:function(){this.list=new h({controller:this.controller})},loadInitialAttachments:function(){if(this.$inputEl.val()){var e=this.$inputEl.data("attachments").map((function(e){return wp.media.model.Attachment.create(e)}));this.controller.get("items").add(e)}},render:function(){this.$el.empty().append(this.list.el,this.addButton.el)}});jQuery((function(){jQuery(".glsri-media").each((function(e,t){var i=jQuery(t),n=i.data("view");n||(n=new m({input:t}),i.siblings(".glsri-media-field").remove(),i.after(n.el),i.data("view",n))}))}))}();