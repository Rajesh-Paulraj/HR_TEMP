!function(){"use strict";var e,t={298:function(){var e=GLSR.addons["site-reviews-forms"];var t=function(e){return!(_.isNull(e)||_.isUndefined(e)||_.isString(e)&&""===jQuery.trim(e)||_.isArray(e)&&_.isEmpty(e))},i={between:function(i,s,l,n){if(t(i)&&(!jQuery.isNumeric(i)||+i<n[0]||+i>n[1]))return wp.i18n.sprintf(e.messages.between,e.labels[s],n[0],n[1])},number:function(i,s,l){if(t(i)&&!jQuery.isNumeric(i))return wp.i18n.sprintf(e.messages.number,e.labels[s])},required:function(i,s,l){if(!t(i))return wp.i18n.sprintf(e.messages.required,e.labels[s])},reserved:function(t,i,s){var l=s.get("type")||"",n=e["reserved_".concat(i,"s")]||[];if("review_"!==l.substring(0,7)&&~n.indexOf(t))return wp.i18n.sprintf(e.messages.reserved,t)},slug:function(t,i,s){if(new RegExp("[^a-z_]").test(t))return wp.i18n.sprintf(e.messages.slug,e.labels[i])},unique:function(i,s,l){var n=_.filter(l.collection.where(function(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}({},s,i)),(function(e){return e.cid!==l.cid}));if(t(i)&&n.length)return wp.i18n.sprintf(e.messages.unique,e.labels[s])}},s=Backbone.Model.extend({defaults:{expanded:!1,format:"",handle:"",hidden:!1,label:"",name:"",options:{},placeholder:"",required:!1,tag:"",tag_label:"",type:"text",value:""},errors:{},getDefaults:function(t){t=t||this.get("type");var i=_.findWhere(e.defaults,{type:t})||{};return _.extend({},_.clone(this.defaults),i)},initialize:function(){this.set("handle",this.getDefaults().handle,{silent:!0})},options:function(){var t=e.options[this.get("type")]||{};return this.get("hidden")&&(t=_.filter(t,(function(e){return"hidden"===e.substring(0,6)})),t=_.map(t,(function(e){return e.replace("hidden:","")}))),t},reset:function(e){e=e||this.get("type");var t=this.get("hidden");this.clear({silent:!0});var i=_.extend({},this.getDefaults(e),{hidden:!!t});return this.set(i,{silent:!0,validate:!0}),this},toggle:function(e){return this.set({expanded:e||!this.get("expanded")},{silent:!0,validate:!1}),this},validate:function(t){var s=this;this.errors={};var l=_.union(this.options(),["name","type"]),n=_.pick(e.validation[t.type],l);if(_.each(n,(function(e,l){_.each(e,(function(e,n){var r=i[n](t[l],l,s,e);r&&(s.errors[l]=r)}))})),!_.isEmpty(this.errors))return console.error(this.errors),!1}}),l=Backbone.Collection.extend({model:s}),n={classes:{active:"is-active",error:"glsrf-field-error",input:"glsr-input",invalid:"is-invalid",mb:"glsr-search-multibox",mb_entries:"glsr-selected-entries",mb_entry:"glsr-multibox-entry",mb_input:"glsr-search-input",mb_result:"glsr-search-result",mb_results:"glsr-search-results",selected:"is-selected",settings:"glsrf-field-settings"},contains:function(e,t){return e.classList.contains(this.classes[t]||t)},selector:function(e){return"."+this.classes[e]||0}},r=function(e){var t=e.split("\n"),i={};return _.map(t,(function(e){(e=e.split(":"))[1]=e[1]||e[0],i[jQuery.trim(e[0])]=jQuery.trim(e[1])})),i},a=function(e){var t=[];return _.map(e,(function(e,i){""===i||i===e?t.push(e):t.push(i+" : "+e)})),t.join("\n")},o=["Down","Enter","Esc","Up"],d=["Tab"],c=Backbone.View.extend({items:null,key:null,template:null,templateEntry:null,events:{"focus .glsr-search-input":"onClickInside","input .glsr-search-input":"onSearch","click .glsr-remove-button":"removeResult","click .glsr-search-result":"selectResult"},initialize:function(){this.template=_.template(jQuery("#glsrf-multibox-result").html()),this.templateEntry=_.template(jQuery("#glsrf-multibox-entry").html()),this.listenTo(this.model,"destroy",this.removeEvents),jQuery(document).on("click."+this.model.cid,this.onClickOutside.bind(this)),jQuery(document).on("keydown."+this.model.cid,this.onKeydown.bind(this)),jQuery(document).on("keyup."+this.model.cid,this.onKeyup.bind(this))},keyDown:function(e){(n.contains(e.target,"mb_input")||n.contains(e.target,"mb_result"))&&(this.triggerKeyDown(),e.preventDefault())},keyEnter:function(e){if(e.target.form&&!~["BUTTON","TEXTAREA"].indexOf(e.target.nodeName))e.preventDefault(),n.contains(e.target,"mb_input")||this.keyEsc(),this.model.trigger("field:validate");else{var t=this.$("."+n.classes.mb_result+"."+n.classes.selected);t.length&&(e.preventDefault(),t.removeClass(n.classes.selected).trigger("click"),this.$(n.selector("mb_input")).focus())}},keyEsc:function(e){e&&n.contains(e.target,"mb_input")&&(this.$(n.selector("mb_input")).val("").blur(),this.refreshResults()),this.$(n.selector("mb_results")).removeClass(n.classes.active),this.$(n.selector("mb_result")).removeClass(n.classes.selected)},keyTab:function(e){n.contains(e.target,"mb_result")?e.shiftKey?this.triggerKeyUp():this.triggerKeyDown():n.contains(e.target,"mb_input")||this.keyEsc(e)},keyUp:function(e){(n.contains(e.target,"mb_input")||n.contains(e.target,"mb_result"))&&(this.triggerKeyUp(),e.preventDefault())},load:function(e){var t=this;this.key=e,_.isEmpty(this.items)?wp.apiFetch({path:"/site-reviews/v1/forms/"+this.key}).then((function(e){t.items=e,t.render()})):this.render()},navigate:function(e){var t=this.$(n.selector("mb_result")),i=t.filter("."+n.classes.selected);i.removeClass(n.classes.selected);var s=i.index();if((s+=e)<0)this.$(n.selector("mb_input")).focus();else{for(;t.eq(s).is(":hidden")&&!(s<0||s>t.length);)s+=e;s=Math.min(s,t.length-1),t.eq(s).addClass(n.classes.selected).focus()}},onClickInside:function(e){this.$(n.selector("mb_result")).removeClass(n.classes.selected),this.$(n.selector("mb_results")).addClass(n.classes.active)},onClickOutside:function(e){jQuery.contains(this.$el[0],e.target)||this.$el[0].offsetWidth<1&&this.$el[0].offsetHeight<1||(this.$el.find("."+n.classes.mbresults).removeClass(n.classes.active),this.keyEsc())},onKeydown:function(e){var t=e.key.replace(/Arrow|ape/g,"");~o.indexOf(t)&&this["key"+t](e)},onKeyup:function(e){var t=e.key.replace(/Arrow|ape/g,"");~d.indexOf(t)&&this["key"+t](e)},onSearch:function(e){_.debounce(this.refreshResults(),500)},refreshResults:function(e){var t=this;e=e||this.model.get(this.key)||[];var i=this.$(n.selector("mb_entries"));i.html(""),_.each(e,(function(e){var s=_.findWhere(t.items,{slug:e});s&&i.append(t.templateEntry(s))}));var s=this.$(n.selector("mb_input")).val();this.$(n.selector("mb_result")).each((function(i,l){var n=t.$(l),r=~e.indexOf(n.data("slug")),a=-1===n.text().toLowerCase().indexOf(s.toLowerCase());n[r||a?"hide":"show"]()}))},removeEvents:function(e){jQuery(document).off("."+e.cid)},removeResult:function(e){var t=this,i=this.$(e.currentTarget).next(),s=i.closest(".glsr-metabox-field").data("option"),l=i.data("slug");if(s){var r=_.without(this.model.get(s)||[],l);this.model.set(s,r,{silent:!0,validate:!0}),i.closest("."+n.classes.mb_entry).css({backgroundColor:"#faafaa"}).fadeOut(350,(function(){t.refreshResults(r),t.$("."+n.classes.mbresult).removeClass(n.classes.selected)}))}},render:function(){var e=this,t=this.$(n.selector("mb_results"));_.each(this.items,(function(i){t.append(e.template(i))})),this.refreshResults()},selectResult:function(e){var t=this.$(e.currentTarget),i=t.closest(".glsr-metabox-field").data("option"),s=t.data("slug");if(i){var l=this.model.get(i)||[];l.push(s),l=_.pluck(_.filter(this.items,(function(e){return~l.indexOf(e.slug)})),"slug"),this.model.set(i,l,{silent:!0,validate:!0}),this.refreshResults(l),this.model.trigger("field:validate:reset",t)}},triggerKeyDown:function(){var e=this.$(n.selector("mb_results"));e.length&&(e.hasClass(n.classes.active)||(this.$(n.selector("mb_result")).removeClass(n.classes.selected),e.addClass(n.classes.active)),this.navigate(1))},triggerKeyUp:function(){this.$(n.selector("mb_results")).length&&this.navigate(-1)}}),u=function(e){if(window.getSelection){var t=window.getSelection(),i=document.createRange();i.selectNodeContents(e),t.removeAllRanges(),t.addRange(i)}},f={Collection:l,Model:s,View:Backbone.View.extend({className:"glsrf-field",multibox:["roles","terms","users","posttypes"],template:null,templates:{type:"#glsrf-field-type",label:"#glsrf-field-label",name:"#glsrf-field-name",options:"#glsrf-field-options",tag:"#glsrf-field-tag",tag_label:"#glsrf-field-tag_label",value:"#glsrf-field-value",format:"#glsrf-field-format",placeholder:"#glsrf-field-placeholder",roles:"#glsrf-field-roles",terms:"#glsrf-field-terms",users:"#glsrf-field-users",posttypes:"#glsrf-field-posttypes",required:"#glsrf-field-required",hidden:"#glsrf-field-hidden"},events:{"click a.remove-field":"removeField","click button.save-field":"saveField","click .template-tag":"selectFieldTag","click a.toggle-field":"toggleField","keyup textarea":"updateFieldOption","keyup input":"updateFieldOption","change input[type=checkbox]":"updateFieldOption","change select":"updateFieldOption"},changeHidden:function(e){this.$el.removeClass(n.classes.invalid),e.reset()},changeType:function(e,t){this.$el.removeClass(n.classes.invalid),e.reset(t)},collapseField:function(){this.model.toggle(!1),this.$(n.selector("settings")).slideUp(200),this.validateField()},expandField:function(){this.model.toggle(!0),this.$(n.selector("settings")).slideDown(200)},initialize:function(){this.$el.attr("data-model-cid",this.model.cid),this.template=_.template(jQuery("#glsrf-field").html()),this.listenTo(this.model,"change:hidden",this.changeHidden),this.listenTo(this.model,"change:type",this.changeType),this.listenTo(this.model,"change",this.refresh),this.listenTo(this.model,"destroy",this.remove),this.listenTo(this.model,"field:expand",this.expandField),this.listenTo(this.model,"field:collapse",this.collapseField),this.listenTo(this.model,"field:validate",this.validateField),this.listenTo(this.model,"field:validate:reset",this.resetValidation)},initializeMultibox:function(e){new c({el:this.$(n.selector("mb")),model:this.model}).load(e)},refresh:function(){this.model.toggle(!0),this.render()},removeField:function(e){e.preventDefault(),this.model.destroy()},render:function(){var t=this;this.$el.html(this.template(this.model.toJSON()));var i=this.$(n.selector("settings")),s=this.model.options();return _.each(this.templates,(function(l,n){if(-1!==_.indexOf(s,n)){var r=_.clone(t.model.toJSON());r.formats=e.formats[r.type],r.options=a(r.options),i.append(_.template(jQuery(l).html())(r)),-1!==_.indexOf(t.multibox,n)&&t.initializeMultibox(n)}})),i.append(_.template(jQuery("#glsrf-field-save").html())),this},resetValidation:function(e){var t=this.$(e).closest(".glsr-metabox-field");t.find("."+n.classes.invalid).removeClass(n.classes.invalid),t.find("."+n.classes.error).remove()},saveField:function(e){this.validateField()&&(this.model.trigger("change"),this.collapseField())},selectFieldTag:function(e){u(e.currentTarget)},toggleField:function(e){var t=this;e.preventDefault(),this.model.toggle(),this.$(n.selector("settings")).slideToggle(200,(function(){GLSR.autosize.update(t.$("textarea"))})),this.validateField()},updateFieldOption:function(e){if("Tab"!==e.key){var t=e.currentTarget,i={validate:!0},s=~["checkbox","radio"].indexOf(t.type)?t.checked:t.value;~["hidden","type"].indexOf(t.dataset.field)||(i.silent=!0),"label"!==t.dataset.field&&(s=jQuery("<div/>").html(s).text()),"options"===t.dataset.field&&(s=r(s)),this.resetValidation(t),this.model.set(t.dataset.field,s,i)}},validateField:function(){var e=this;return _.isEmpty(this.model.errors)?(this.$el.removeClass(n.classes.invalid),!0):(this.$el.addClass(n.classes.invalid),_.each(this.model.errors,(function(t,i){var s=e.$("[data-field="+i+"]");e.resetValidation(s),s.addClass(n.classes.invalid).closest("."+n.classes.input).append(_.template(jQuery("#glsrf-field-error").html())({error:t}))})),!1)}})},h=Backbone.View.extend({data:[],el:"#glsrf",fields:null,sortable:null,tippy:[],events:{"click button.add-field":"createField","click button.collapse-all":"collapseFields","click button.expand-all":"expandFields"},addField:function(e){var t=new f.View({model:e});this.$el.find(".glsrf-fields").append(t.render().el)},addFields:function(){this.$el.find(".glsrf-fields").html(""),this.fields.each(this.addField,this)},createField:function(e){e.preventDefault();var t=new f.Model;this.fields.each((function(e){return e.trigger("field:collapse")})),this.fields.add(t),this.refreshSortable(),t.trigger("field:expand")},collapseFields:function(e){e.currentTarget.blur(),this.fields.each((function(e){return e.trigger("field:collapse")}))},expandFields:function(e){e.currentTarget.blur(),this.fields.each((function(e){return e.trigger("field:expand")}))},initialize:function(){this.fields=new f.Collection,this.initializeData(),this.initializeSortable(),this.render(),this.listenTo(this.fields,"add",this.addField),this.listenTo(this.fields,"reset",this.addFields),this.listenTo(this.fields,"all",_.debounce(this.render,0))},initializeAutosize:function(){GLSR.autosize(this.$el.find("textarea"))},initializeData:function(){try{this.data=JSON.parse(this.$el.find("#glsrf-data").val()),this.fields.add(this.data),this.addFields()}catch(e){console.error(e)}},initializeSortable:function(){this.sortable=this.$el.find(".glsrf-fields").sortable({delay:150,items:".glsrf-field",handle:".glsrf-field-handle .sortable-drag",tolerance:"pointer",scroll:!1,start:function(e,t){t.placeholder.outerHeight(t.item.outerHeight())},stop:this.sortFields.bind(this)})},initializeTippy:function(){_.each(this.tippy,(function(e){return e.destroy()})),this.tippy=GLSR.Tippy.tippy("[data-tippy-content]",{delay:[200,null],followCursor:"horizontal",offset:[-50,10],placement:"top-start",plugins:[GLSR.Tippy.plugins.followCursor]})},refreshData:function(){var e=[];this.fields.each((function(t){t.isValid(),_.isEmpty(t.errors)&&e.push(t.toJSON())})),this.$el.find("#glsrf-data").val(JSON.stringify(e)),this.data=e},refreshSortable:function(){null!==this.sortable&&this.sortable.sortable("refresh")},render:function(){return this.toggleWelcome(),this.refreshData(),this.initializeAutosize(),this.initializeTippy(),this},sortFields:function(){var e=this;this.$el.find(".glsrf-fields").children().each((function(t,i){var s=jQuery(i).attr("data-model-cid"),l=e.fields.get(s);l&&(e.fields.remove(l,{silent:!0}),e.fields.add(l,{silent:!0,sort:!e.fields.comparator}))})),this.fields.trigger("form:reorder")},toggleWelcome:function(){this.$el.find(".glsrf-no-fields")[this.fields.length?"hide":"show"](),this.$el.find(".glsrf-actions > div")[this.fields.length?"show":"hide"]()}});jQuery((function(e){var t=e(".glsrf-template");t.length&&(wp.codeEditor.initialize(t,cm_settings),new h),e(document).on("postbox-toggled",(function(){e(".CodeMirror").each((function(e,t){t.CodeMirror.refresh()}))})),e("code[data-select-text]").on("click",(function(e){u(e.currentTarget)}));e("select#site-reviews-form").on("change",(function t(i){var s=i.target,l=s.closest(".inside"),n={},r=s.value;n[GLSR.nameprefix]={_action:"metabox-details",_nonce:GLSR.nonce["metabox-details"],form_id:r,post_id:e("#post_ID").val()},wp.ajax.post(GLSR.action,n).done((function(i){GLSR.stars.destroy(),e(l).find(".glsr-metabox-field.glsr-field").remove(),e(l).append(i.items),e(l).find("#site-reviews-form").val(r),e(l).find("#site-reviews-form").on("change",t),GLSR.stars.rebuild()})).always((function(){}))}))}))},115:function(){},889:function(){},142:function(){}},i={};function s(e){var l=i[e];if(void 0!==l)return l.exports;var n=i[e]={exports:{}};return t[e](n,n.exports,s),n.exports}s.m=t,e=[],s.O=function(t,i,l,n){if(!i){var r=1/0;for(c=0;c<e.length;c++){i=e[c][0],l=e[c][1],n=e[c][2];for(var a=!0,o=0;o<i.length;o++)(!1&n||r>=n)&&Object.keys(s.O).every((function(e){return s.O[e](i[o])}))?i.splice(o--,1):(a=!1,n<r&&(r=n));if(a){e.splice(c--,1);var d=l();void 0!==d&&(t=d)}}return t}n=n||0;for(var c=e.length;c>0&&e[c-1][2]>n;c--)e[c]=e[c-1];e[c]=[i,l,n]},s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},function(){var e={110:0,613:0,271:0,494:0};s.O.j=function(t){return 0===e[t]};var t=function(t,i){var l,n,r=i[0],a=i[1],o=i[2],d=0;if(r.some((function(t){return 0!==e[t]}))){for(l in a)s.o(a,l)&&(s.m[l]=a[l]);if(o)var c=o(s)}for(t&&t(i);d<r.length;d++)n=r[d],s.o(e,n)&&e[n]&&e[n][0](),e[n]=0;return s.O(c)},i=self.webpackChunk=self.webpackChunk||[];i.forEach(t.bind(null,0)),i.push=t.bind(null,i.push.bind(i))}(),s.O(void 0,[613,271,494],(function(){return s(298)})),s.O(void 0,[613,271,494],(function(){return s(115)})),s.O(void 0,[613,271,494],(function(){return s(889)}));var l=s.O(void 0,[613,271,494],(function(){return s(142)}));l=s.O(l)}();